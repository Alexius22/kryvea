import { mdiFileEdit } from "@mdi/js";
import axios from "axios";
import { useEffect, useState } from "react";
import { useNavigate, useParams } from "react-router";
import { getData } from "../api/api";
import Card from "../components/CardBox/Card";
import CardTitle from "../components/CardBox/CardTitle";
import Grid from "../components/Composition/Grid";
import Divider from "../components/Divider";
import Button from "../components/Form/Button";
import Buttons from "../components/Form/Buttons";
import Label from "../components/Form/Label";
import MonacoCodeEditor from "../components/Poc/MonacoCodeEditor";
import { POC_TYPE_IMAGE, POC_TYPE_REQUEST_RESPONSE, POC_TYPE_TEXT } from "../components/Poc/Poc.consts";
import { PocDoc } from "../components/Poc/Poc.types";
import SectionTitleLineWithButton from "../components/Section/SectionTitleLineWithButton";
import { Poc, uuidZero, Vulnerability } from "../types/common.types";

function PocImagePreview({ poc }: { poc: PocDoc }) {
  if (poc.type !== POC_TYPE_IMAGE) return;
  const [imageUrl, setImageUrl] = useState<string>();

  useEffect(() => {
    if (!poc.image_id || poc.image_id === uuidZero) {
      return;
    }

    axios.get(`/api/files/${poc.image_id}`, { responseType: "blob" }).then(({ data }) => {
      const url = URL.createObjectURL(data);
      setImageUrl(url);
    });

    return () => {
      if (imageUrl) {
        URL.revokeObjectURL(imageUrl);
      }
    };
  }, [poc]);

  return (
    <figure className="inline-block text-center">
      <img src={imageUrl} alt={poc.image_caption || poc.description} className="vuln-detail-poc-img" />
      <figcaption className="mt-2 text-sm italic">{poc.image_caption}</figcaption>
    </figure>
  );
}

function PocItem({ poc }: { poc: PocDoc }) {
  switch (poc.type) {
    case POC_TYPE_REQUEST_RESPONSE:
      return (
        <section className="@container">
          <p>{poc.description}</p>
          {poc.uri && <p className="mb-1">{poc.uri}</p>}
          <div className="grid grid-cols-1 gap-4 @[1300px]:grid-cols-2">
            <div className="vuln-detail-req-res-body">
              <h3 className="vuln-detail-req-res-header sticky left-0">Request</h3>
              <MonacoCodeEditor
                language={"http"}
                value={poc.request}
                options={{
                  minimap: { enabled: false },
                }}
              />
            </div>
            <div className="vuln-detail-req-res-body">
              <h3 className="vuln-detail-req-res-header sticky left-0">Response</h3>
              <MonacoCodeEditor
                language={"http"}
                value={poc.response}
                options={{
                  minimap: { enabled: false },
                }}
              />
            </div>
          </div>
          <Divider />
        </section>
      );
    case POC_TYPE_IMAGE:
      return (
        <section>
          <p className="mb-4">{poc.description}</p>
          <PocImagePreview poc={poc} />
          <Divider />
        </section>
      );
    case POC_TYPE_TEXT:
      return (
        <section>
          <p className="mb-4">{poc.description}</p>
          <Label text={`Language: ${poc.text_language}`} />
          <pre className="vuln-detail-poc-text">
            <code>{poc.text_data}</code>
          </pre>
          <Divider />
        </section>
      );
    default:
      return null;
  }
}

// Helper: Extract all non-empty CVSS objects from the vulnerability
function getCvssList(vuln) {
  const versions = ["cvssv2", "cvssv3", "cvssv31", "cvssv4"];
  return versions
    .map(ver => ({
      version: ver,
      ...vuln[ver],
    }))
    .filter(cvss => cvss && (cvss.cvss_score > 0 || cvss.cvss_vector || cvss.cvss_severity || cvss.cvss_description));
}

export default function VulnerabilityDetail() {
  const { assessmentId, vulnerabilityId } = useParams();
  const navigate = useNavigate();

  const [vulnerability, setVulnerability] = useState(null);
  const [pocs, setPocs] = useState([]);

  useEffect(() => {
    document.title = "Vulnerability detail";

    getData<Vulnerability>(`/api/vulnerabilities/${vulnerabilityId}`, setVulnerability);

    getData<Poc[]>(`/api/vulnerabilities/${vulnerabilityId}/pocs`, setPocs);
  }, [assessmentId, vulnerabilityId]);

  if (!vulnerability) {
    return null;
  }

  const cvssList = getCvssList(vulnerability);

  return (
    <div className="max-w-full">
      <SectionTitleLineWithButton
        icon={undefined}
        title={`${vulnerability.category.index} - ${vulnerability.category.name}${vulnerability.detailed_title ? ` (${vulnerability.detailed_title})` : ""}`}
        main
      >
        <Buttons noWrap>
          <Button icon={mdiFileEdit} text="Edit Vulnerability" small onClick={() => navigate(`edit`)} />
          <Button icon={mdiFileEdit} text="Edit PoC" small onClick={() => navigate(`pocs`)} />
        </Buttons>
      </SectionTitleLineWithButton>

      <Grid className="gap-4 overflow-x-auto">
        <Card className="flex overflow-hidden !p-0">
          {(() => {
            const labelColWidth = 15;
            const cvssColCount = cvssList.length;
            const cvssColWidth = 85 / cvssColCount;

            return (
              <table className="table" style={{ width: "100%" }}>
                <colgroup>
                  <col style={{ width: `${labelColWidth}%` }} />
                  {cvssList.map((_, idx) => (
                    <col key={idx} style={{ width: `${cvssColWidth}%` }} />
                  ))}
                </colgroup>
                <thead>
                  <tr>
                    <th></th>
                    {cvssList.map((cvss, idx) => (
                      <th className="text-center" key={idx}>
                        CVSSv{cvss.cvss_version}
                      </th>
                    ))}
                  </tr>
                </thead>
                <tbody className="border-none">
                  <tr>
                    <th>Severity</th>
                    {cvssList.map((cvss, idx) => (
                      <td className="text-center" key={idx}>
                        {cvss.cvss_severity}
                      </td>
                    ))}
                  </tr>
                  <tr>
                    <th>Score</th>
                    {cvssList.map((cvss, idx) => (
                      <td className="text-center" key={idx}>
                        {cvss.cvss_score}
                      </td>
                    ))}
                  </tr>
                  <tr>
                    <th>Vector</th>
                    {cvssList.map((cvss, idx) => (
                      <td className="text-center" key={idx}>
                        {cvss.cvss_vector}
                      </td>
                    ))}
                  </tr>
                  <tr>
                    <th>Description</th>
                    {cvssList.map((cvss, idx) => (
                      <td className="content-start text-justify" key={idx}>
                        {cvss.cvss_description}
                      </td>
                    ))}
                  </tr>
                </tbody>
              </table>
            );
          })()}
        </Card>

        <Card className="flex overflow-hidden !p-0">
          <table className="table" style={{ width: "100%" }}>
            <colgroup>
              <col style={{ width: "10%" }} />
              <col style={{ width: "90%" }} />
            </colgroup>
            <tbody className="border-none">
              <tr>
                <th>Generic description</th>
                <td>{vulnerability.generic_description.text}</td>
              </tr>
              <tr>
                <th>Detailed description</th>
                <td>{vulnerability.description}</td>
              </tr>
              <tr>
                <th>Remediation</th>
                <td>{vulnerability.generic_remediation.text + vulnerability.remediation}</td>
              </tr>
              <tr>
                <th>References</th>
                <td>
                  <ul>
                    {(vulnerability.references || []).map((reference, index) => (
                      <li key={index}>{reference}</li>
                    ))}
                  </ul>
                </td>
              </tr>
              <tr>
                <th>Target</th>
                <td>
                  {(() => {
                    const ip = vulnerability.target.ipv4 || vulnerability.target.ipv6 || "";
                    if (ip) {
                      return ip + (vulnerability.target.fqdn ? ` - ${vulnerability.target.fqdn}` : "");
                    }
                    return vulnerability.target.fqdn;
                  })()}
                </td>
              </tr>
              <tr>
                <th>User</th>
                <td>{vulnerability.user.username}</td>
              </tr>
            </tbody>
          </table>
        </Card>

        <Card>
          <CardTitle title="Proofs of Concept" />
          {pocs.length === 0 ? (
            <div className="font-thin text-[color:--border-primary-highlight]">
              No PoCs available for this vulnerability.
            </div>
          ) : (
            pocs.sort((a, b) => a.index - b.index).map(poc => <PocItem key={poc.id} poc={poc} />)
          )}
        </Card>
      </Grid>
    </div>
  );
}
