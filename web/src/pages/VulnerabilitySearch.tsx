import { mdiTabSearch } from "@mdi/js";
import { useEffect, useState } from "react";
import toast from "react-hot-toast";
import { Link } from "react-router";
import { getData } from "../api/api";
import { formatDate } from "../components/dateUtils";
import SectionTitleLineWithButton from "../components/Section/SectionTitleLineWithButton";
import Table from "../components/Table";
import { getPageTitle } from "../config";
import { Vulnerability } from "../types/common.types";

export default function VulnerabilitySearch() {
  const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([]);

  useEffect(() => {
    document.title = getPageTitle("Vulnerability Search");
    getData<Vulnerability[]>("/api/vulnerabilities/search?query=", setVulnerabilities, err => {
      const errorMessage = err.response.data.error;
      toast.error(errorMessage);
    });
  }, []);

  return (
    <div>
      <SectionTitleLineWithButton icon={mdiTabSearch} title="Vulnerability Search" />
      <Table
        data={vulnerabilities?.map(vulnerability => ({
          Vulnerability: (
            <Link to={`/vulnerability/`}>
              {`${vulnerability.category.index} - ${vulnerability.category.name} (${vulnerability.detailed_title})`}
            </Link>
          ),
          Description: vulnerability.description,
          "CVSSv3.1 Score": vulnerability.cvssv31.cvss_score,
          "CVSSv4.0 Score": vulnerability.cvssv4.cvss_score,
          Assessment: (
            <Link to={`/customers/${vulnerability.assessment.id}/assessments`}>{vulnerability.assessment.name}</Link>
          ),
          "Last update": formatDate(vulnerability.updated_at),
          User: vulnerability.user.username,
        }))}
        perPageCustom={50}
        maxWidthColumns={{ Description: "20rem" }}
      />
    </div>
  );
}
