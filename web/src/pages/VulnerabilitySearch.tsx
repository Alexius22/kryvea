import { mdiTabSearch } from "@mdi/js";
import { useEffect, useState } from "react";
import { Link, useLocation, useNavigate } from "react-router";
import { getData } from "../api/api";
import Card from "../components/Composition/Card";
import Divider from "../components/Composition/Divider";
import Flex from "../components/Composition/Flex";
import Grid from "../components/Composition/Grid";
import PageHeader from "../components/Composition/PageHeader";
import Table from "../components/Composition/Table";
import Button from "../components/Form/Button";
import Checkbox from "../components/Form/Checkbox";
import DateCalendar from "../components/Form/DateCalendar";
import Input from "../components/Form/Input";
import Label from "../components/Form/Label";
import { useDebounce } from "../hooks/useDebounce";
import { Vulnerability } from "../types/common.types";
import { formatDate } from "../utils/dates";
import { getPageTitle } from "../utils/helpers";

const searchAPI = `/api/vulnerabilities/search?`;
const DEFAULT_QUERY = "";
const DEFAULT_PAGE = 1;
const DEFAULT_LIMIT = 50;

const CVSS_VERSIONS = [
  { value: "3.1", label: "CVSS v3.1" },
  { value: "4.0", label: "CVSS v4.0" },
];

export default function VulnerabilitySearch() {
  const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([]);
  const [totalVulnerabilities, setTotalVulnerabilities] = useState(0);
  const [totalPages, setTotalPages] = useState(0);

  const location = useLocation();
  const params = new URLSearchParams(location.search);

  // Main search
  const [query, setQuery] = useState(params.get("query") ?? DEFAULT_QUERY);
  const debouncedQuery = useDebounce(query, 400);

  // Pagination
  const [page, setPage] = useState(Math.max(+params.get("page") || DEFAULT_PAGE, DEFAULT_PAGE));
  const [limit, setLimit] = useState(+params.get("limit") || DEFAULT_LIMIT);

  // Filters
  const [assessment, setAssessment] = useState(params.get("assessment") ?? "");
  const [user, setUser] = useState(params.get("user") ?? "");
  const [customer, setCustomer] = useState(params.get("customer") ?? "");
  const [cvssMin, setCvssMin] = useState(params.get("cvss_min") ?? "");
  const [cvssMax, setCvssMax] = useState(params.get("cvss_max") ?? "");
  const [cvssVersions, setCvssVersions] = useState<string[]>(
    params.get("cvss_versions")?.split(",").filter(Boolean) ?? []
  );
  const [dateRange, setDateRange] = useState<{ start: string; end: string }>({
    start: params.get("start_date_time") ?? "",
    end: params.get("end_date_time") ?? "",
  });

  const navigate = useNavigate();

  const fetchVulnerabilitiesPaginated = searchParams =>
    getData<{ total_pages: number; total_documents: number; data: Vulnerability[] }>(searchAPI + searchParams, data => {
      setTotalVulnerabilities(data.total_documents);
      setVulnerabilities(data.data);
      setTotalPages(data.total_pages);
    });

  useEffect(() => {
    document.title = getPageTitle("Vulnerability Search");
  }, []);

  // Sync with URL when user uses browser buttons
  useEffect(() => {
    setQuery(params.get("query") ?? DEFAULT_QUERY);
    setPage(Math.max(+params.get("page") || DEFAULT_PAGE, DEFAULT_PAGE));
    setLimit(+params.get("limit") || DEFAULT_LIMIT);
    setAssessment(params.get("assessment") ?? "");
    setUser(params.get("user") ?? "");
    setCustomer(params.get("customer") ?? "");
    setCvssMin(params.get("cvss_min") ?? "");
    setCvssMax(params.get("cvss_max") ?? "");
    setCvssVersions(params.get("cvss_versions")?.split(",").filter(Boolean) ?? []);
    setDateRange({
      start: params.get("start_date_time") ?? "",
      end: params.get("end_date_time") ?? "",
    });
  }, [location.search]);

  // Fetch data
  useEffect(() => {
    const searchParams = buildSearchParams();

    if (location.search !== `?${searchParams}`) {
      navigate(`?${searchParams}`, { replace: false });
    }

    fetchVulnerabilitiesPaginated(searchParams);
  }, [debouncedQuery, limit, page]);

  // Build API params
  const buildSearchParams = () => {
    const sp = new URLSearchParams({
      query: debouncedQuery,
      page: page.toString(),
      limit: limit.toString(),
    });

    if (assessment) sp.set("assessment", assessment);
    if (user) sp.set("user", user);
    if (customer) sp.set("customer", customer);
    if (cvssMin) sp.set("cvss_min", cvssMin);
    if (cvssMax) sp.set("cvss_max", cvssMax);
    if (cvssVersions.length) sp.set("cvss_versions", cvssVersions.join(","));
    if (dateRange.start) sp.set("start_date_time", dateRange.start);
    if (dateRange.end) sp.set("end_date_time", dateRange.end);

    return sp.toString();
  };

  // Actions
  const handleSearch = () => {
    setPage(1); // reset page
    const searchParams = buildSearchParams();
    navigate(`?${searchParams}`);
    fetchVulnerabilitiesPaginated(searchParams);
  };

  const handleClearAll = () => {
    setQuery("");
    setAssessment("");
    setUser("");
    setCustomer("");
    setCvssMin("");
    setCvssMax("");
    setCvssVersions([]);
    setDateRange({ start: "", end: "" });
    setPage(DEFAULT_PAGE);
    setLimit(DEFAULT_LIMIT);
    navigate("?");
  };

  return (
    <div>
      <PageHeader icon={mdiTabSearch} title="Vulnerability Search" />

      <Grid className="gap-4">
        <Card>
          <Grid className="grid-cols-3 !items-start gap-4">
            <Input
              type="text"
              id="assessment"
              label="Assessment"
              placeholder="Assessment name"
              value={assessment}
              onChange={e => setAssessment(e.target.value)}
              onEnter={handleSearch}
            />
            <Input
              type="text"
              id="user"
              label="User"
              placeholder="User"
              value={user}
              onChange={e => setUser(e.target.value)}
              onEnter={handleSearch}
            />
            <Grid className="h-full items-center justify-center">
              <Label text="CVSS Versions" className="text-center" />
              <Flex className="gap-4">
                {CVSS_VERSIONS.map(({ value, label }) => (
                  <Checkbox
                    disabled
                    id={`cvss_${value}`}
                    label={label}
                    checked={cvssVersions.includes(value)}
                    onChange={() => {
                      setCvssVersions(prev =>
                        prev.includes(value) ? prev.filter(v => v !== value) : [...prev, value]
                      );
                    }}
                    key={value}
                  />
                ))}
              </Flex>
            </Grid>
            <DateCalendar
              idStart="start_date_time"
              label="Range date"
              isRange
              value={dateRange}
              onChange={val => {
                const { start, end } = val as { start: string; end: string };
                setDateRange({ start, end });
              }}
              placeholder={{ start: "Start date", end: "End date" }}
            />
            <Input
              disabled
              helperSubtitle="Work in progress"
              type="text"
              id="customer"
              label="Customer"
              placeholder="Customer name"
              value={customer}
              onChange={e => setCustomer(e.target.value)}
              onEnter={handleSearch}
            />
            <Flex className="gap-4">
              <Input
                type="text"
                id="cvss_min_score"
                label="CVSS Min"
                placeholder="CVSS min"
                value={cvssMin}
                onChange={e => setCvssMin(e.target.value)}
                onEnter={handleSearch}
              />
              <Input
                type="text"
                id="cvss_max_score"
                label="CVSS Max"
                placeholder="CVSS max"
                value={cvssMax}
                onChange={e => setCvssMax(e.target.value)}
                onEnter={handleSearch}
              />
            </Flex>
          </Grid>
          <Divider />
          <Flex items="center" justify="between">
            <span>
              Total vulnerabilities found: <b>{totalVulnerabilities}</b>
            </span>
            <Flex className="gap-2">
              <Button text="Clear all" variant="outline-only" onClick={handleClearAll} />
              <Button text="Search" onClick={handleSearch} />
            </Flex>
          </Flex>
        </Card>

        <Table
          backendCurrentPage={page}
          backendTotalRows={totalVulnerabilities}
          backendTotalPages={totalPages}
          backendSearch={query}
          onBackendSearch={setQuery}
          onBackendChangePage={setPage}
          onBackendChangePerPage={setLimit}
          data={vulnerabilities?.map(vulnerability => ({
            Vulnerability: (
              <Link
                to={`/customers/${vulnerability.target.customer.id}/assessments/${vulnerability.assessment.id}/vulnerabilities/${vulnerability.id}`}
                title={
                  vulnerability.detailed_title
                    ? `${vulnerability.category.index} - ${vulnerability.category.name} (${vulnerability.detailed_title})`
                    : `${vulnerability.category.index} - ${vulnerability.category.name}`
                }
              >
                {vulnerability.detailed_title
                  ? `${vulnerability.category.index} - ${vulnerability.category.name} (${vulnerability.detailed_title})`
                  : `${vulnerability.category.index} - ${vulnerability.category.name}`}
              </Link>
            ),
            Description: vulnerability.description,
            "CVSSv3.1 Score": vulnerability.cvssv31.score,
            "CVSSv4.0 Score": vulnerability.cvssv4.score,
            Assessment: (
              <Link
                to={`/customers/${vulnerability.target.customer.id}/assessments/${vulnerability.assessment.id}/vulnerabilities`}
                title={vulnerability.assessment.name}
              >
                {vulnerability.assessment.name}
              </Link>
            ),
            "Last update": formatDate(vulnerability.updated_at),
            User: vulnerability.user.username,
          }))}
          perPageCustom={limit}
          maxWidthColumns={{
            Vulnerability: "30rem",
            Description: "20rem",
            Assessment: "20rem",
          }}
        />
      </Grid>
    </div>
  );
}
