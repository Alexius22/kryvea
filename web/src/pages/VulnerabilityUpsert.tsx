import { useContext, useEffect, useState } from "react";
import { useNavigate, useParams } from "react-router";
import { toast } from "react-toastify";
import { getData, postData, putData } from "../api/api";
import { GlobalContext } from "../App";
import Card from "../components/CardBox/Card";
import Grid from "../components/Composition/Grid";
import CVSS31Wrapper from "../components/CVSS/CVSS31Wrapper/CVSS31Wrapper";
import CVSS40Wrapper from "../components/CVSS/CVSS40Wrapper/CVSS40Wrapper";
import Divider from "../components/Divider";
import Button from "../components/Form/Button";
import Buttons from "../components/Form/Buttons";
import Checkbox from "../components/Form/Checkbox";
import Input from "../components/Form/Input";
import SelectWrapper from "../components/Form/SelectWrapper";
import { SelectOption } from "../components/Form/SelectWrapper.types";
import Textarea from "../components/Form/Textarea";
import { Assessment, Category, Target, Vulnerability } from "../types/common.types";

export default function VulnerabilityUpsert() {
  const { assessmentId, vulnerabilityId } = useParams<{ assessmentId: string; vulnerabilityId?: string }>();
  const {
    useCtxCustomer: [ctxCustomer],
  } = useContext(GlobalContext);
  const navigate = useNavigate();

  const [categories, setCategories] = useState<Category[]>([]);
  const [targets, setTargets] = useState<Target[]>([]);
  const [assessment, setAssessment] = useState<Assessment | null>(null);
  const [selectedVulnerability, setSelectedVulnerability] = useState<SelectOption | null>(null);
  const [targetId, setTargetId] = useState<string>("");
  const [status, setStatus] = useState("open");
  const [checkedItems, setCheckedItems] = useState({
    all_categories: false,
    generic_remediation: true,
  });
  const [form, setForm] = useState({
    detailed_title: "",
    status: "",
    cvssv31_vector: "",
    cvssv4_vector: "",
    description: "",
    remediation: "",
    references: [],
  });

  useEffect(() => {
    getData<Category[]>("/api/categories", setCategories);
    getData<Target[]>(`/api/customers/${ctxCustomer.id}/targets`, setTargets);
    if (ctxCustomer.id && assessmentId) {
      getData<Assessment>(`/api/assessments/${assessmentId}`, setAssessment);
    }
  }, [ctxCustomer.id, assessmentId]);

  useEffect(() => {
    if (!vulnerabilityId) {
      return;
    }
    getData<Vulnerability>(`/api/vulnerabilities/${vulnerabilityId}`, data => {
      setSelectedVulnerability({
        label: `${data.category.index} - ${data.category.name}`,
        value: data.category.id,
      });
      setTargetId(data.target.id);
      setForm({
        detailed_title: data.detailed_title,
        status: data.status,
        cvssv31_vector: data.cvssv31.cvss_vector,
        cvssv4_vector: data.cvssv4.cvss_vector,
        description: data.description,
        remediation: data.remediation,
        references: data.references,
      });
      setCheckedItems({
        all_categories: false,
        generic_remediation: data.generic_remediation?.enabled ?? false,
      });
    });
  }, [assessmentId, vulnerabilityId]);

  useEffect(() => {
    // If currently selected vulnerability is no longer in the filtered list, reset it
    if (
      selectedVulnerability &&
      !vulnerabilitySelectOptions.some(option => option.value === selectedVulnerability.value)
    ) {
      setSelectedVulnerability(null);
    }
  }, [checkedItems.all_categories, categories]);

  const vulnerabilitySelectOptions: SelectOption[] = (
    checkedItems.all_categories
      ? categories
      : categories.filter(category => category.source !== "nessus" && category.source !== "burp")
  ).map(item => ({
    label: `${item.index} - ${item.name}`,
    value: item.id,
  }));

  const targetOptions: SelectOption[] = targets.map(target => ({
    value: target.id,
    label: `${target.fqdn}${target.ipv4 ? " - " + target.ipv4 : target.ipv6 ? " - " + target.ipv6 : ""}${target.name ? " (" + target.name + ")" : ""}`,
  }));

  const handleCheckboxChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { id, checked } = e.target;
    setCheckedItems(prev => ({
      ...prev,
      [id]: checked,
    }));
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { id, value } = e.target;
    setForm(prev => ({
      ...prev,
      [id]: value,
    }));
  };

  const handleReferencesChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    setForm(prev => ({
      ...prev,
      references: e.target.value.split("\n").filter(Boolean),
    }));
  };

  const handleSubmit = () => {
    const payload = {
      assessment_id: assessmentId,
      category_id: selectedVulnerability?.value,
      target_id: targetId,
      detailed_title: form.detailed_title,
      status: form.status,
      cvssv31_vector: form.cvssv31_vector,
      cvssv4_vector: form.cvssv4_vector,
      description: form.description,
      remediation: form.remediation,
      references: form.references,
      generic_remediation: checkedItems.generic_remediation,
    };

    const onSuccess = () => {
      toast.success(`Vulnerability ${vulnerabilityId ? "updated" : "added"}!`);
      navigate(-1);
    };

    if (vulnerabilityId) {
      putData(`/api/vulnerabilities/${vulnerabilityId}`, payload, onSuccess);
    } else {
      postData(`/api/vulnerabilities`, payload, onSuccess);
    }
  };

  return (
    <Card>
      <h2 className="text-xl font-bold">{vulnerabilityId ? "Edit Vulnerability" : "New Vulnerability"}</h2>
      <Grid className="grid-cols-2">
        <SelectWrapper
          label="Vulnerability category"
          id="category"
          options={vulnerabilitySelectOptions}
          value={selectedVulnerability}
          onChange={setSelectedVulnerability}
        />
        <Grid>
          <Checkbox
            id="all_categories"
            checked={checkedItems.all_categories}
            onChange={handleCheckboxChange}
            label="Show categories from all sources"
          />
          <Checkbox
            id="generic_remediation"
            checked={checkedItems.generic_remediation}
            onChange={handleCheckboxChange}
            label="Generic remediation"
          />
        </Grid>
      </Grid>

      <Grid className="grid-cols-3">
        <Input
          label="Detailed title"
          type="text"
          id="detailed_title"
          placeholder="Additional detail"
          value={form.detailed_title}
          onChange={handleInputChange}
        />
        <SelectWrapper
          label="Target"
          id="target_id"
          options={targetOptions}
          value={targetOptions.find(opt => opt.value === targetId) || null}
          onChange={option => setTargetId(option.value)}
        />
        <SelectWrapper
          label="Status"
          id="status"
          options={[
            { value: "open", label: "Open" },
            { value: "closed", label: "Closed" },
          ]}
          value={status ? { value: status, label: status.charAt(0).toUpperCase() + status.slice(1) } : null}
          onChange={option => setStatus(option.value)}
        />
      </Grid>

      {assessment?.cvss_versions["3.1"] && (
        <CVSS31Wrapper
          value={form.cvssv31_vector}
          onChange={value =>
            setForm(prev => ({
              ...prev,
              cvssv31_vector: value,
            }))
          }
        />
      )}
      {assessment?.cvss_versions["4.0"] && (
        <CVSS40Wrapper
          value={form.cvssv4_vector}
          onChange={value =>
            setForm(prev => ({
              ...prev,
              cvssv4_vector: value,
            }))
          }
        />
      )}
      <Divider />
      <Textarea
        id="description"
        label="Description"
        placeholder="Description here"
        value={form.description}
        onChange={handleInputChange}
      />
      <Textarea
        id="remediation"
        label="Remediation"
        placeholder="Remediation here"
        value={form.remediation}
        onChange={handleInputChange}
      />
      <Textarea
        id="references"
        label="References"
        placeholder="Additional references here"
        value={form.references?.join("\n")}
        onChange={handleReferencesChange}
      />
      <Divider />
      <Buttons>
        <Button text={vulnerabilityId ? "Update" : "Submit"} onClick={handleSubmit} />
        <Button variant="secondary" text="Cancel" onClick={() => navigate(-1)} />
      </Buttons>
    </Card>
  );
}
